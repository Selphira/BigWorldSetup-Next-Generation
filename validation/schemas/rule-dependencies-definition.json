{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://selphira.github.io/BigWorldSetup-Enhanced-Edition/validation/schemas/dependencies.json",
  "title": "Big World Setup - Enhanced Edition: Dependency Rules",
  "description": "Schema for validating dependency rules files",
  "type": "object",
  "required": ["rules"],
  "additionalProperties": false,
  "properties": {
    "rules": {
      "type": "array",
      "items": {"$ref": "#/definitions/dependencyRule"}
    }
  },
  "definitions": {
    "componentReference": {
      "type": "string",
      "pattern": "^[a-zA-Z0-9_#'-]+(:([0-9]+|\\*|[0-9]+\\?[0-9_]+))?$",
      "description": "Component reference as string: 'mod_id' or 'mod_id:component'"
    },
    "componentReferenceList": {
      "type": "array",
      "minItems": 1,
      "items": {"$ref": "#/definitions/componentReference"}
    },
    "ruleSeverity": {
      "type": "string",
      "enum": ["error", "warning", "info"],
      "default": "error"
    },
    "dependencyMode": {
      "type": "string",
      "enum": ["any", "all"],
      "default": "any"
    },
    "dependencyRuleBase": {
      "type": "object",
      "required": [],
      "additionalProperties": false,
      "properties": {
        "mode": {"$ref": "#/definitions/dependencyMode"},
        "severity": {
          "$ref": "#/definitions/ruleSeverity",
          "description": "Severity level of the rule violation"
        },
        "description": {
          "type": "string",
          "description": "Human-readable explanation of the rule"
        },
        "translations": {
          "type": "object",
          "description": "Translations per language",
          "minProperties": 1,
          "patternProperties": {
            "^[a-z]{2}_[A-Z]{2}$": {
              "type": "string"
            }
          },
          "additionalProperties": false
        },
        "source_url": {
          "type": "string",
          "format": "uri",
          "description": "Optional URL for documentation"
        },
        "implicit_order": {
          "type": "boolean",
          "default": true
        },
        "source": {
          "$ref": "#/definitions/componentReferenceList",
          "description": "Target component(s) of the rule"
        },
        "source_groups": {
          "type": "array",
          "minItems": 1,
          "items": {"$ref": "#/definitions/componentReferenceList"}
        },
        "target": {
          "$ref": "#/definitions/componentReferenceList",
          "description": "Target component(s) of the rule"
        },
        "target_groups": {
          "type": "array",
          "minItems": 1,
          "items": {"$ref": "#/definitions/componentReferenceList"}
        }
      }
    },
    "dependencyRule": {
      "allOf": [
        {"$ref": "#/definitions/dependencyRuleBase"},
        {
          "anyOf": [
            {"required": ["source"]},
            {"required": ["source_groups"]}
          ]
        },
        {
          "anyOf": [
            {"required": ["target"]},
            {"required": ["target_groups"]}
          ]
        },
        {
          "not": {
            "required": ["source", "source_groups"]
          }
        },
        {
          "not": {
            "required": ["target", "target_groups"]
          }
        }
      ]
    }
  }
}